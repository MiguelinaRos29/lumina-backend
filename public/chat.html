<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Lumina - Asistente IA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
    }

    :root {
      --bg-dark: #020617;
      --bg-darker: #020617;
      --bg-main: #020617;
      --bg-chat: #020617;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.12);
      --border-subtle: #1f2937;
      --text-main: #e5e7eb;
      --text-soft: #9ca3af;
      --error: #f97373;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #0b1120, #020617 55%);
      color: var(--text-main);
      height: 100vh;
      overflow: hidden;
    }

    .app {
      display: grid;
      grid-template-columns: 260px minmax(0, 1fr);
      height: 100vh;
    }

    /* SIDEBAR */

    .sidebar {
      background: linear-gradient(to bottom, #020617, #020617);
      border-right: 1px solid var(--border-subtle);
      padding: 16px 14px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 4px;
    }

    .logo-circle {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #38bdf8, #0ea5e9 40%, #020617 80%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
      color: white;
      box-shadow: 0 0 25px rgba(56, 189, 248, 0.6);
    }

    .sidebar-title {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .sidebar-title h1 {
      font-size: 16px;
      margin: 0;
    }

    .sidebar-title span {
      font-size: 11px;
      color: var(--text-soft);
    }

    .sidebar-section-title {
      font-size: 11px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: var(--text-soft);
      margin: 4px 0;
    }

    .mode-buttons {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .mode-btn {
      background: transparent;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      padding: 7px 10px;
      font-size: 12px;
      color: var(--text-main);
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: all 0.16s ease;
    }

    .mode-btn span {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .mode-btn small {
      font-size: 10px;
      color: var(--text-soft);
    }

    .mode-btn:hover {
      border-color: var(--accent);
      background: rgba(15, 23, 42, 0.8);
    }

    .mode-btn.active {
      border-color: var(--accent);
      background: var(--accent-soft);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.2);
    }

    .sidebar-footer {
      margin-top: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      font-size: 11px;
      color: var(--text-soft);
    }

    .clear-btn {
      border-radius: 999px;
      border: 1px dashed var(--border-subtle);
      background: transparent;
      color: var(--text-soft);
      padding: 6px 10px;
      font-size: 11px;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .clear-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(15, 23, 42, 0.8);
    }

    /* CHAT AREA */

    .chat {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: radial-gradient(circle at top, #020617, #020617 55%);
    }

    .chat-header {
      padding: 10px 18px;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .chat-header-left {
      display: flex;
      flex-direction: column;
    }

    .chat-header-left h2 {
      font-size: 14px;
      margin: 0;
    }

    .chat-header-left span {
      font-size: 11px;
      color: var(--text-soft);
    }

    .chat-header-pill {
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid #16a34a33;
      padding: 3px 8px;
      color: #22c55e;
      background: rgba(22, 163, 74, 0.1);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .chat-header-pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 10px #22c55e;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px 20px 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      scroll-behavior: smooth;
    }

    .messages-inner {
      max-width: 820px;
      width: 100%;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .message {
      display: flex;
      gap: 10px;
      font-size: 14px;
    }

    .message.user {
      justify-content: flex-end;
    }

    .message.assistant {
      justify-content: flex-start;
    }

    .avatar {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      flex-shrink: 0;
    }

    .avatar.user {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #ecfdf5;
    }

    .avatar.assistant {
      background: radial-gradient(circle at 30% 20%, #38bdf8, #0ea5e9 60%, #020617);
      color: #f9fafb;
      box-shadow: 0 0 18px rgba(56, 189, 248, 0.5);
    }

    .bubble {
      padding: 9px 11px;
      border-radius: 14px;
      max-width: 88%;
      line-height: 1.5;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-size: 14px;
    }

    .message.user .bubble {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #ecfdf5;
      border-bottom-right-radius: 4px;
    }

    .message.assistant .bubble {
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid #1f2937;
      border-bottom-left-radius: 4px;
    }

    /* Estilos dentro de la burbuja para Markdown */
    .bubble h1,
    .bubble h2,
    .bubble h3 {
      margin: 0 0 6px;
      font-weight: 600;
    }

    .bubble h1 {
      font-size: 17px;
    }
    .bubble h2 {
      font-size: 16px;
    }
    .bubble h3 {
      font-size: 15px;
    }

    .bubble ul {
      padding-left: 18px;
      margin: 4px 0 4px;
    }

    .bubble li {
      margin-bottom: 3px;
    }

    .bubble strong {
      font-weight: 600;
    }

    .bubble em {
      font-style: italic;
    }

    .typing {
      font-size: 12px;
      color: var(--text-soft);
      padding: 4px 20px 0;
    }

    .hidden {
      display: none;
    }

    .input-area-wrapper {
      border-top: 1px solid var(--border-subtle);
      padding: 10px 18px 14px;
      background: linear-gradient(to top, #020617, rgba(15, 23, 42, 0.9));
    }

    .input-area {
      max-width: 820px;
      margin: 0 auto;
      display: flex;
      align-items: flex-end;
      gap: 10px;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 14px;
      border: 1px solid var(--border-subtle);
      padding: 8px 10px;
    }

    .input-area textarea {
      flex: 1;
      resize: none;
      border: none;
      background: transparent;
      color: var(--text-main);
      font-family: inherit;
      font-size: 14px;
      max-height: 120px;
      min-height: 36px;
      outline: none;
    }

    .send-btn {
      border-radius: 999px;
      border: none;
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      background: linear-gradient(135deg, #38bdf8, #0ea5e9);
      color: #0b1120;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 8px 18px rgba(56, 189, 248, 0.35);
      transition: transform 0.12s ease, box-shadow 0.12s ease, opacity 0.12s ease;
      flex-shrink: 0;
    }

    .send-btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(56, 189, 248, 0.45);
    }

    .send-btn:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }

    .shortcut-hint {
      font-size: 11px;
      color: var(--text-soft);
      text-align: right;
      margin-top: 4px;
      max-width: 820px;
      margin-inline: auto;
    }

    /* Simple scrollbar */

    .messages::-webkit-scrollbar {
      width: 8px;
    }

    .messages::-webkit-scrollbar-track {
      background: transparent;
    }

    .messages::-webkit-scrollbar-thumb {
      background: #111827;
      border-radius: 999px;
    }

    @media (max-width: 840px) {
      .app {
        grid-template-columns: 1fr;
      }

      .sidebar {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="logo-circle">L</div>
        <div class="sidebar-title">
          <h1>Lumina</h1>
          <span>Asistente IA para tus proyectos</span>
        </div>
      </div>

      <div>
        <div class="sidebar-section-title">Modos r√°pidos</div>
        <div class="mode-buttons">
          <button class="mode-btn" data-mode="Organizaci√≥n">
            <span>üóÇ Organizaci√≥n</span>
            <small>Agenda, tareas, planes</small>
          </button>
          <button class="mode-btn" data-mode="Ventas">
            <span>üí∏ Ventas</span>
            <small>Ofertas, guiones, funnels</small>
          </button>
          <button class="mode-btn" data-mode="Contenido">
            <span>üìù Contenidos</span>
            <small>Posts, guiones, ideas</small>
          </button>
          <button class="mode-btn" data-mode="Ciberdemia">
            <span>üéì Ciberdemia</span>
            <small>Cursos, manuales, Moodle</small>
          </button>
        </div>
      </div>

      <div class="sidebar-footer">
        <button class="clear-btn" id="clear-chat">
          üßπ Limpiar chat
        </button>
        <div>
          <div>üí° Tip:</div>
          <div>Usa los modos para enfocar a Lumina.</div>
        </div>
      </div>
    </aside>

    <!-- CHAT AREA -->
    <main class="chat">
      <header class="chat-header">
        <div class="chat-header-left">
          <h2>Chat con Lumina</h2>
          <span>Organizaci√≥n, ventas y contenidos para tus proyectos</span>
        </div>
        <div class="chat-header-pill">
          <span class="chat-header-pill-dot"></span>
          Online
        </div>
      </header>

      <section class="messages" id="messages">
        <div class="messages-inner" id="messages-inner">
          <!-- Mensajes se insertan aqu√≠ -->
        </div>
      </section>

      <div id="typing" class="typing hidden">Lumina est√° escribiendo‚Ä¶</div>

      <div class="input-area-wrapper">
        <form id="chat-form" class="input-area">
          <textarea
            id="user-input"
            placeholder="Escribe tu mensaje para Lumina..."
          ></textarea>
          <button type="submit" id="send-btn" class="send-btn">
            <span>Enviar</span> <span>‚Æû</span>
          </button>
        </form>
        <div class="shortcut-hint">
          Enter: enviar ¬∑ Shift + Enter: salto de l√≠nea
        </div>
      </div>
    </main>
  </div>

  <script>
    const messagesContainer = document.getElementById("messages");
    const messagesInner = document.getElementById("messages-inner");
    const typingEl = document.getElementById("typing");
    const form = document.getElementById("chat-form");
    const input = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");
    const clearBtn = document.getElementById("clear-chat");
    const modeButtons = document.querySelectorAll(".mode-btn");

    let currentMode = null;

    // --- Identificador de cliente (para futuro SaaS) ---
let clientId = localStorage.getItem("luminaClientId");
if (!clientId) {
  clientId = "client_" + Math.random().toString(36).slice(2, 10);
  localStorage.setItem("luminaClientId", clientId);
}

    // --- Funci√≥n simple para renderizar Markdown ---
    function renderMarkdown(text) {
      if (!text) return "";

      // Escapar HTML b√°sico
      let html = text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");

      // T√≠tulos
      html = html.replace(/^### (.*)$/gim, "<h3>$1</h3>");
      html = html.replace(/^## (.*)$/gim, "<h2>$1</h2>");
      html = html.replace(/^# (.*)$/gim, "<h1>$1</h1>");

      // Negrita y cursiva
      html = html.replace(/\*\*(.*?)\*\*/gim, "<strong>$1</strong>");
      html = html.replace(/\*(.*?)\*/gim, "<em>$1</em>");

      // Listas con * o -
      html = html.replace(/^\s*[-*] (.*)$/gim, "<li>$1</li>");
      // Agrupar lis en un ul (simple, aunque no perfecto)
      html = html.replace(/(<li>[\s\S]*?<\/li>)/gim, "<ul>$1</ul>");

      // Saltos de l√≠nea
      html = html.replace(/\n/g, "<br />");

      return html.trim();
    }

    // Cargamos historial
    let history = [];
    try {
      history = JSON.parse(localStorage.getItem("luminaHistory") || "[]");
    } catch {
      history = [];
    }

    function scrollToBottom() {
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function saveHistory() {
      localStorage.setItem("luminaHistory", JSON.stringify(history));
    }

    function createMessageElement(role, content) {
      const wrapper = document.createElement("div");
      wrapper.className = `message ${role}`;

      const avatar = document.createElement("div");
      avatar.className = `avatar ${role}`;
      avatar.textContent = role === "user" ? "T√∫" : "L";

      const bubble = document.createElement("div");
      bubble.className = "bubble";

      if (role === "assistant") {
        bubble.innerHTML = renderMarkdown(content);
      } else {
        bubble.textContent = content;
      }

      if (role === "user") {
        wrapper.appendChild(bubble);
        wrapper.appendChild(avatar);
      } else {
        wrapper.appendChild(avatar);
        wrapper.appendChild(bubble);
      }

      messagesInner.appendChild(wrapper);
    }

    function renderHistory() {
      messagesInner.innerHTML = "";
      history.forEach((msg) => {
        createMessageElement(msg.role, msg.content);
      });
      scrollToBottom();
    }

    async function sendMessage(text) {
  const trimmed = text.trim();
  if (!trimmed) return;

  let finalText = trimmed;
  if (currentMode) {
    finalText = `[MODO: ${currentMode}] ${trimmed}`;
  }

  const userMessage = { role: "user", content: finalText };
  history.push(userMessage);
  createMessageElement("user", finalText);
  saveHistory();
  scrollToBottom();

  input.value = "";
  input.style.height = "auto";
  input.focus();

  sendBtn.disabled = true;
  typingEl.classList.remove("hidden");

  try {
    const res = await fetch("/api/chat", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        message: finalText,
        history: history,
        clientId: clientId, // <-- ya incluido
      }),
    });

    const data = await res.json();
    const reply =
      data.reply ||
      "‚ö†Ô∏è No he podido generar una respuesta en este momento.";

    const botMessage = { role: "assistant", content: reply };
    history.push(botMessage);
    createMessageElement("assistant", reply);
    saveHistory();
    scrollToBottom();
  } catch (err) {
    console.error(err);
    const errorMsg =
      "‚ö†Ô∏è Ha ocurrido un error al conectar con el servidor de Lumina.";
    const botMessage = { role: "assistant", content: errorMsg };
    history.push(botMessage);
    createMessageElement("assistant", errorMsg);
    saveHistory();
    scrollToBottom();
  } finally {
    typingEl.classList.add("hidden");
    sendBtn.disabled = false;
  }
}


    // Manejo del formulario
    form.addEventListener("submit", (e) => {
      e.preventDefault();
      sendMessage(input.value);
    });

    // Enter = enviar, Shift+Enter = salto de l√≠nea
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        form.dispatchEvent(new Event("submit"));
      }
    });

    // Ajustar autom√°ticamente altura del textarea
    input.addEventListener("input", () => {
      input.style.height = "auto";
      input.style.height = Math.min(input.scrollHeight, 120) + "px";
    });

    // Bot√≥n limpiar chat
    clearBtn.addEventListener("click", () => {
      if (!confirm("¬øSeguro que quieres borrar toda la conversaci√≥n?")) return;
      history = [];
      saveHistory();
      messagesInner.innerHTML = "";
      const welcome = {
        role: "assistant",
        content:
          "Hola, soy Lumina. Estoy lista para ayudarte con organizaci√≥n, ventas o contenidos. ¬øPor d√≥nde empezamos?",
      };
      history.push(welcome);
      createMessageElement("assistant", welcome.content);
      saveHistory();
      scrollToBottom();
    });

    // Botones de modo
modeButtons.forEach((btn) => {
  btn.addEventListener("click", () => {
    const selectedMode = btn.dataset.mode;

    // Si vuelves a pulsar el mismo, se desactiva
    if (currentMode === selectedMode) {
      currentMode = null;
      btn.classList.remove("active");
      return;
    }

    // Activar nuevo modo
    currentMode = selectedMode;
    modeButtons.forEach((b) => b.classList.remove("active"));
    btn.classList.add("active");

    // Mensaje autom√°tico seg√∫n el modo elegido
    const presetByMode = {
      "Organizaci√≥n": "Ay√∫dame a organizar mis tareas y mi semana.",
      "Ventas": "Ay√∫dame con ideas de ventas y estrategias para mis servicios.",
      "Contenido": "Ay√∫dame a crear contenidos para redes sociales y mis proyectos.",
      "Ciberdemia": "Ay√∫dame con ideas, estructura o ventas para Ciberdemia y sus cursos."
    };

    const texto =
      presetByMode[selectedMode] || `Quiero trabajar en modo ${selectedMode}.`;

    // Enviamos el mensaje usando el modo actual
    sendMessage(texto);
  });
});


    // Render inicial
    if (history.length === 0) {
      const welcome = {
        role: "assistant",
        content:
          "Hola, soy Lumina. Estoy lista para ayudarte con organizaci√≥n, ventas o contenidos de Open Consultech y Ciberdemia. Cu√©ntame qu√© necesitas.",
      };
      history.push(welcome);
      saveHistory();
    }

    renderHistory();
  </script>
</body>
</html>
